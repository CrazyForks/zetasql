[default language_features=V_1_4_MATCH_RECOGNIZE,V_1_4_MULTILEVEL_AGGREGATION,V_1_1_ORDER_BY_IN_AGGREGATE,V_1_1_LIMIT_IN_AGGREGATE,V_1_1_HAVING_IN_AGGREGATE,V_1_1_NULL_HANDLING_MODIFIER_IN_AGGREGATE,ANALYTIC_FUNCTIONS,V_1_3_QUALIFY,V_1_4_GROUPING_BUILTIN,V_1_2_GROUP_BY_STRUCT]
[default show_unparsed]
[default also_show_signature_mismatch_details]

SELECT * FROM SimpleTypes
MATCH_RECOGNIZE(
  {{PARTITION BY int64, int32|}}
  ORDER BY string
  MEASURES
    MAX(int32 + SUM(int32 + int64 + MIN(double) GROUP BY int64) GROUP BY int32) AS max_agg,
    ARRAY_AGG(string GROUP BY string ORDER BY MIN(double)) AS array_agg
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--

ALTERNATION GROUP: PARTITION BY int64, int32
--
QueryStmt
+-output_column_list=
| +-$partitionby.int64#20 AS int64 [INT64]
| +-$partitionby.int32#21 AS int32 [INT32]
| +-$match_recognize.max_agg#32 AS max_agg [DOUBLE]
| +-$match_recognize.array_agg#38 AS array_agg [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$partitionby.int64#20, $partitionby.int32#21, $match_recognize.max_agg#32, $match_recognize.array_agg#38]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$partitionby.int64#20, $partitionby.int32#21, $match_recognize.max_agg#32, $match_recognize.array_agg#38]
        +-expr_list=
        | +-max_agg#32 := ColumnRef(type=DOUBLE, column=$aggregate.$agg1#31)
        | +-array_agg#38 := ColumnRef(type=ARRAY<STRING>, column=$aggregate.$agg2#37)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$partitionby.int64#20, $partitionby.int32#21, $aggregate.$agg1#31, $aggregate.$agg2#37]
            +-input_scan=
            | +-ProjectScan
            |   +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, SimpleTypes.double#9, $partitionby.int64#20, $partitionby.int32#21]
            |   +-expr_list=
            |   | +-int64#20 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            |   | +-int32#21 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |   +-input_scan=
            |     +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
            +-partition_by=
            | +-WindowPartitioning
            |   +-partition_by_list=
            |     +-ColumnRef(type=INT64, column=$partitionby.int64#20)
            |     +-ColumnRef(type=INT32, column=$partitionby.int32#21)
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=$partitionby.int64#20)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=$partitionby.int32#21)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
                +-aggregate_list=
                  +-$agg1#31 :=
                  | +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                  |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |     +-Cast(INT32 -> DOUBLE)
                  |     | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#24)
                  |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#30)
                  |   +-group_by_list=
                  |   | +-$groupbymod#22 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                  |   | +-$groupbymod#23 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                  |   | +-$groupbymod#24 := ColumnRef(type=INT32, column=$partitionby.int32#21)
                  |   +-group_by_aggregate_list=
                  |     +-$agg1#30 :=
                  |       +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                  |         +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |           +-Cast(INT64 -> DOUBLE)
                  |           | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                  |           |   +-Cast(INT32 -> INT64)
                  |           |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#27)
                  |           |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#28)
                  |           +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#29)
                  |         +-group_by_list=
                  |         | +-$groupbymod#25 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                  |         | +-$groupbymod#26 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                  |         | +-$groupbymod#27 := ColumnRef(type=INT32, column=$partitionby.int32#21)
                  |         | +-$groupbymod#28 := ColumnRef(type=INT64, column=$partitionby.int64#20)
                  |         +-group_by_aggregate_list=
                  |           +-$agg1#29 :=
                  |             +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                  |               +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
                  +-$agg2#37 :=
                    +-AggregateFunctionCall(ZetaSQL:array_agg(STRING) -> ARRAY<STRING>)
                      +-ColumnRef(type=STRING, column=$group_by_list.$groupbymod#35)
                      +-order_by_item_list=
                      | +-OrderByItem
                      |   +-column_ref=
                      |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#36)
                      +-group_by_list=
                      | +-$groupbymod#33 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                      | +-$groupbymod#34 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                      | +-$groupbymod#35 := ColumnRef(type=STRING, column=SimpleTypes.string#5)
                      +-group_by_aggregate_list=
                        +-$agg1#36 :=
                          +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                            +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_11.a_6 AS int64,
  matchrecognizescan_11.a_7 AS int32,
  matchrecognizescan_11.a_9 AS max_agg,
  matchrecognizescan_11.a_10 AS array_agg
FROM
  (
    SELECT
      simpletypes_5.a_1 AS a_1,
      simpletypes_5.a_2 AS a_2,
      simpletypes_5.a_3 AS a_3,
      simpletypes_5.a_4 AS a_4,
      simpletypes_5.a_2 AS a_6,
      simpletypes_5.a_1 AS a_7
    FROM
      (
        SELECT
          SimpleTypes.int32 AS a_1,
          SimpleTypes.int64 AS a_2,
          SimpleTypes.string AS a_3,
          SimpleTypes.double AS a_4
        FROM
          SimpleTypes
      ) AS simpletypes_5
  ) AS projectscan_8 MATCH_RECOGNIZE(
    PARTITION BY projectscan_8.a_6, projectscan_8.a_7
    ORDER BY projectscan_8.a_3
    MEASURES
      MAX(CAST(projectscan_8.a_7 AS DOUBLE) + (SUM(CAST(CAST(projectscan_8.a_7 AS INT64) + (projectscan_8.a_6) AS DOUBLE) +
          (MIN(projectscan_8.a_4))
          GROUP BY projectscan_8.a_2, projectscan_8.a_1, projectscan_8.a_7, projectscan_8.a_6))
        GROUP BY projectscan_8.a_2, projectscan_8.a_1, projectscan_8.a_7) AS a_9,
      ARRAY_AGG(projectscan_8.a_3
        GROUP BY projectscan_8.a_2, projectscan_8.a_1, projectscan_8.a_3
        ORDER BY MIN(projectscan_8.a_4)) AS a_10
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(projectscan_8.a_6) < 10,
      B AS(projectscan_8.a_7) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_11;
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$match_recognize.max_agg#26 AS max_agg [DOUBLE]
| +-$match_recognize.array_agg#30 AS array_agg [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=$match_recognize.[max_agg#26, array_agg#30]
    +-input_scan=
      +-ProjectScan
        +-column_list=$match_recognize.[max_agg#26, array_agg#30]
        +-expr_list=
        | +-max_agg#26 := ColumnRef(type=DOUBLE, column=$aggregate.$agg1#25)
        | +-array_agg#30 := ColumnRef(type=ARRAY<STRING>, column=$aggregate.$agg2#29)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=$aggregate.[$agg1#25, $agg2#29]
            +-input_scan=
            | +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
                +-aggregate_list=
                  +-$agg1#25 :=
                  | +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                  |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |     +-Cast(INT32 -> DOUBLE)
                  |     | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#20)
                  |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#24)
                  |   +-group_by_list=
                  |   | +-$groupbymod#20 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                  |   +-group_by_aggregate_list=
                  |     +-$agg1#24 :=
                  |       +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                  |         +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |           +-Cast(INT64 -> DOUBLE)
                  |           | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                  |           |   +-Cast(INT32 -> INT64)
                  |           |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#21)
                  |           |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#22)
                  |           +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#23)
                  |         +-group_by_list=
                  |         | +-$groupbymod#21 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                  |         | +-$groupbymod#22 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                  |         +-group_by_aggregate_list=
                  |           +-$agg1#23 :=
                  |             +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                  |               +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
                  +-$agg2#29 :=
                    +-AggregateFunctionCall(ZetaSQL:array_agg(STRING) -> ARRAY<STRING>)
                      +-ColumnRef(type=STRING, column=$group_by_list.$groupbymod#27)
                      +-order_by_item_list=
                      | +-OrderByItem
                      |   +-column_ref=
                      |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#28)
                      +-group_by_list=
                      | +-$groupbymod#27 := ColumnRef(type=STRING, column=SimpleTypes.string#5)
                      +-group_by_aggregate_list=
                        +-$agg1#28 :=
                          +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                            +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_8.a_6 AS max_agg,
  matchrecognizescan_8.a_7 AS array_agg
FROM
  (
    SELECT
      SimpleTypes.int32 AS a_1,
      SimpleTypes.int64 AS a_2,
      SimpleTypes.string AS a_3,
      SimpleTypes.double AS a_4
    FROM
      SimpleTypes
  ) AS simpletypes_5 MATCH_RECOGNIZE(
    ORDER BY simpletypes_5.a_3
    MEASURES
      MAX(CAST(simpletypes_5.a_1 AS DOUBLE) + (SUM(CAST(CAST(simpletypes_5.a_1 AS INT64) + (simpletypes_5.a_2) AS DOUBLE) +
          (MIN(simpletypes_5.a_4))
          GROUP BY simpletypes_5.a_1, simpletypes_5.a_2))
        GROUP BY simpletypes_5.a_1) AS a_6,
      ARRAY_AGG(simpletypes_5.a_3
        GROUP BY simpletypes_5.a_3
        ORDER BY MIN(simpletypes_5.a_4)) AS a_7
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(simpletypes_5.a_2) < 10,
      B AS(simpletypes_5.a_1) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_8;
==

# Adds pattern variables
SELECT * FROM SimpleTypes
MATCH_RECOGNIZE(
  {{PARTITION BY int64, int32|}}
  ORDER BY string
  MEASURES
    MAX(A.int32 + SUM(A.int32 + A.int64 + MIN(A.double) GROUP BY A.int64) GROUP BY A.int32) +
    MAX(B.int32 + SUM(B.int32 + B.int64 + MIN(B.double) GROUP BY B.int64) GROUP BY B.int32) +
    MAX(int32 + SUM(int32 + int64 + MIN(double) GROUP BY int64) GROUP BY int32) AS m
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--
ALTERNATION GROUP: PARTITION BY int64, int32
--
QueryStmt
+-output_column_list=
| +-$partitionby.int64#20 AS int64 [INT64]
| +-$partitionby.int32#21 AS int32 [INT32]
| +-$match_recognize.m#52 AS m [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[$partitionby.int64#20, $partitionby.int32#21, $match_recognize.m#52]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$partitionby.int64#20, $partitionby.int32#21, $match_recognize.m#52]
        +-expr_list=
        | +-m#52 :=
        |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
        |     +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
        |     | +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#31)
        |     | +-ColumnRef(type=DOUBLE, column=$aggregate.$agg2#41)
        |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg3#51)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$partitionby.int64#20, $partitionby.int32#21, $aggregate.$agg3#51, $aggregate.$agg2#41, $aggregate.$agg1#31]
            +-input_scan=
            | +-ProjectScan
            |   +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, SimpleTypes.double#9, $partitionby.int64#20, $partitionby.int32#21]
            |   +-expr_list=
            |   | +-int64#20 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            |   | +-int32#21 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |   +-input_scan=
            |     +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
            +-partition_by=
            | +-WindowPartitioning
            |   +-partition_by_list=
            |     +-ColumnRef(type=INT64, column=$partitionby.int64#20)
            |     +-ColumnRef(type=INT32, column=$partitionby.int32#21)
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=$partitionby.int64#20)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=$partitionby.int32#21)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
              | +-aggregate_list=
              |   +-$agg3#51 :=
              |     +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
              |       +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |         +-Cast(INT32 -> DOUBLE)
              |         | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#44)
              |         +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#50)
              |       +-group_by_list=
              |       | +-$groupbymod#42 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
              |       | +-$groupbymod#43 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |       | +-$groupbymod#44 := ColumnRef(type=INT32, column=$partitionby.int32#21)
              |       +-group_by_aggregate_list=
              |         +-$agg1#50 :=
              |           +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
              |             +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |               +-Cast(INT64 -> DOUBLE)
              |               | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
              |               |   +-Cast(INT32 -> INT64)
              |               |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#47)
              |               |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#48)
              |               +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#49)
              |             +-group_by_list=
              |             | +-$groupbymod#45 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
              |             | +-$groupbymod#46 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |             | +-$groupbymod#47 := ColumnRef(type=INT32, column=$partitionby.int32#21)
              |             | +-$groupbymod#48 := ColumnRef(type=INT64, column=$partitionby.int64#20)
              |             +-group_by_aggregate_list=
              |               +-$agg1#49 :=
              |                 +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
              |                   +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
              +-MeasureGroup
              | +-pattern_variable_ref=
              | | +-MatchRecognizePatternVariableRef(name="B")
              | +-aggregate_list=
              |   +-$agg2#41 :=
              |     +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
              |       +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |         +-Cast(INT32 -> DOUBLE)
              |         | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#34)
              |         +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#40)
              |       +-group_by_list=
              |       | +-$groupbymod#32 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
              |       | +-$groupbymod#33 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |       | +-$groupbymod#34 := ColumnRef(type=INT32, column=$partitionby.int32#21)
              |       +-group_by_aggregate_list=
              |         +-$agg1#40 :=
              |           +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
              |             +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |               +-Cast(INT64 -> DOUBLE)
              |               | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
              |               |   +-Cast(INT32 -> INT64)
              |               |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#37)
              |               |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#38)
              |               +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#39)
              |             +-group_by_list=
              |             | +-$groupbymod#35 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
              |             | +-$groupbymod#36 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |             | +-$groupbymod#37 := ColumnRef(type=INT32, column=$partitionby.int32#21)
              |             | +-$groupbymod#38 := ColumnRef(type=INT64, column=$partitionby.int64#20)
              |             +-group_by_aggregate_list=
              |               +-$agg1#39 :=
              |                 +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
              |                   +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
              +-MeasureGroup
                +-pattern_variable_ref=
                | +-MatchRecognizePatternVariableRef(name="A")
                +-aggregate_list=
                  +-$agg1#31 :=
                    +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                      +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                        +-Cast(INT32 -> DOUBLE)
                        | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#24)
                        +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#30)
                      +-group_by_list=
                      | +-$groupbymod#22 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                      | +-$groupbymod#23 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                      | +-$groupbymod#24 := ColumnRef(type=INT32, column=$partitionby.int32#21)
                      +-group_by_aggregate_list=
                        +-$agg1#30 :=
                          +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                            +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                              +-Cast(INT64 -> DOUBLE)
                              | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                              |   +-Cast(INT32 -> INT64)
                              |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#27)
                              |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#28)
                              +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#29)
                            +-group_by_list=
                            | +-$groupbymod#25 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                            | +-$groupbymod#26 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                            | +-$groupbymod#27 := ColumnRef(type=INT32, column=$partitionby.int32#21)
                            | +-$groupbymod#28 := ColumnRef(type=INT64, column=$partitionby.int64#20)
                            +-group_by_aggregate_list=
                              +-$agg1#29 :=
                                +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                                  +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_12.a_6 AS int64,
  matchrecognizescan_12.a_7 AS int32,
  ((matchrecognizescan_12.a_11) + (matchrecognizescan_12.a_10)) + (matchrecognizescan_12.a_9) AS m
FROM
  (
    SELECT
      simpletypes_5.a_1 AS a_1,
      simpletypes_5.a_2 AS a_2,
      simpletypes_5.a_3 AS a_3,
      simpletypes_5.a_4 AS a_4,
      simpletypes_5.a_2 AS a_6,
      simpletypes_5.a_1 AS a_7
    FROM
      (
        SELECT
          SimpleTypes.int32 AS a_1,
          SimpleTypes.int64 AS a_2,
          SimpleTypes.string AS a_3,
          SimpleTypes.double AS a_4
        FROM
          SimpleTypes
      ) AS simpletypes_5
  ) AS projectscan_8 MATCH_RECOGNIZE(
    PARTITION BY projectscan_8.a_6, projectscan_8.a_7
    ORDER BY projectscan_8.a_3
    MEASURES
      MAX(CAST(projectscan_8.a_7 AS DOUBLE) + (SUM(CAST(CAST(projectscan_8.a_7 AS INT64) + (projectscan_8.a_6) AS DOUBLE) +
          (MIN(projectscan_8.a_4))
          GROUP BY projectscan_8.a_2, projectscan_8.a_1, projectscan_8.a_7, projectscan_8.a_6))
        GROUP BY projectscan_8.a_2, projectscan_8.a_1, projectscan_8.a_7) AS a_9,
      MAX(CAST(B.a_7 AS DOUBLE) + (SUM(CAST(CAST(B.a_7 AS INT64) + (B.a_6) AS DOUBLE) + (MIN(B.a_4))
          GROUP BY B.a_2, B.a_1, B.a_7, B.a_6))
        GROUP BY B.a_2, B.a_1, B.a_7) AS a_10,
      MAX(CAST(A.a_7 AS DOUBLE) + (SUM(CAST(CAST(A.a_7 AS INT64) + (A.a_6) AS DOUBLE) + (MIN(A.a_4))
          GROUP BY A.a_2, A.a_1, A.a_7, A.a_6))
        GROUP BY A.a_2, A.a_1, A.a_7) AS a_11
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(projectscan_8.a_6) < 10,
      B AS(projectscan_8.a_7) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_12;
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$match_recognize.m#38 AS m [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[$match_recognize.m#38]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$match_recognize.m#38]
        +-expr_list=
        | +-m#38 :=
        |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
        |     +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
        |     | +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#25)
        |     | +-ColumnRef(type=DOUBLE, column=$aggregate.$agg2#31)
        |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg3#37)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=$aggregate.[$agg3#37, $agg2#31, $agg1#25]
            +-input_scan=
            | +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
              | +-aggregate_list=
              |   +-$agg3#37 :=
              |     +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
              |       +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |         +-Cast(INT32 -> DOUBLE)
              |         | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#32)
              |         +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#36)
              |       +-group_by_list=
              |       | +-$groupbymod#32 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |       +-group_by_aggregate_list=
              |         +-$agg1#36 :=
              |           +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
              |             +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |               +-Cast(INT64 -> DOUBLE)
              |               | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
              |               |   +-Cast(INT32 -> INT64)
              |               |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#33)
              |               |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#34)
              |               +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#35)
              |             +-group_by_list=
              |             | +-$groupbymod#33 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |             | +-$groupbymod#34 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
              |             +-group_by_aggregate_list=
              |               +-$agg1#35 :=
              |                 +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
              |                   +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
              +-MeasureGroup
              | +-pattern_variable_ref=
              | | +-MatchRecognizePatternVariableRef(name="B")
              | +-aggregate_list=
              |   +-$agg2#31 :=
              |     +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
              |       +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |         +-Cast(INT32 -> DOUBLE)
              |         | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#26)
              |         +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#30)
              |       +-group_by_list=
              |       | +-$groupbymod#26 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |       +-group_by_aggregate_list=
              |         +-$agg1#30 :=
              |           +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
              |             +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
              |               +-Cast(INT64 -> DOUBLE)
              |               | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
              |               |   +-Cast(INT32 -> INT64)
              |               |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#27)
              |               |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#28)
              |               +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#29)
              |             +-group_by_list=
              |             | +-$groupbymod#27 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
              |             | +-$groupbymod#28 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
              |             +-group_by_aggregate_list=
              |               +-$agg1#29 :=
              |                 +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
              |                   +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
              +-MeasureGroup
                +-pattern_variable_ref=
                | +-MatchRecognizePatternVariableRef(name="A")
                +-aggregate_list=
                  +-$agg1#25 :=
                    +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                      +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                        +-Cast(INT32 -> DOUBLE)
                        | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#20)
                        +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#24)
                      +-group_by_list=
                      | +-$groupbymod#20 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                      +-group_by_aggregate_list=
                        +-$agg1#24 :=
                          +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                            +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                              +-Cast(INT64 -> DOUBLE)
                              | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                              |   +-Cast(INT32 -> INT64)
                              |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#21)
                              |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#22)
                              +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#23)
                            +-group_by_list=
                            | +-$groupbymod#21 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                            | +-$groupbymod#22 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                            +-group_by_aggregate_list=
                              +-$agg1#23 :=
                                +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                                  +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  ((matchrecognizescan_9.a_8) + (matchrecognizescan_9.a_7)) + (matchrecognizescan_9.a_6) AS m
FROM
  (
    SELECT
      SimpleTypes.int32 AS a_1,
      SimpleTypes.int64 AS a_2,
      SimpleTypes.string AS a_3,
      SimpleTypes.double AS a_4
    FROM
      SimpleTypes
  ) AS simpletypes_5 MATCH_RECOGNIZE(
    ORDER BY simpletypes_5.a_3
    MEASURES
      MAX(CAST(simpletypes_5.a_1 AS DOUBLE) + (SUM(CAST(CAST(simpletypes_5.a_1 AS INT64) + (simpletypes_5.a_2) AS DOUBLE) +
          (MIN(simpletypes_5.a_4))
          GROUP BY simpletypes_5.a_1, simpletypes_5.a_2))
        GROUP BY simpletypes_5.a_1) AS a_6,
      MAX(CAST(B.a_1 AS DOUBLE) + (SUM(CAST(CAST(B.a_1 AS INT64) + (B.a_2) AS DOUBLE) + (MIN(B.a_4))
          GROUP BY B.a_1, B.a_2))
        GROUP BY B.a_1) AS a_7,
      MAX(CAST(A.a_1 AS DOUBLE) + (SUM(CAST(CAST(A.a_1 AS INT64) + (A.a_2) AS DOUBLE) + (MIN(A.a_4))
          GROUP BY A.a_1, A.a_2))
        GROUP BY A.a_1) AS a_8
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(simpletypes_5.a_2) < 10,
      B AS(simpletypes_5.a_1) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_9;
==

# Multilevel aggs with pattern variable references detects conflicting vars,
# including in arguments
SELECT * FROM SimpleTypes
MATCH_RECOGNIZE(
  ORDER BY string
  MEASURES
    MAX(double + SUM(double + int64 + MIN(A.int32) GROUP BY int64) GROUP BY double) AS max_agg
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:43]
    MAX(double + SUM(double + int64 + MIN(A.int32) GROUP BY int64) GROUP BY d...
                                          ^
==

# Multilevel aggs with pattern variable references detects conflicting vars,
# including in ORDER BY, even when the args are constants and do not tell the
# scope.
SELECT * FROM SimpleTypes
MATCH_RECOGNIZE(
  ORDER BY string
  MEASURES
      {{ANY_VALUE(ARRAY_AGG(1 ORDER BY double) GROUP BY A.int64) AS m,|}}
      ANY_VALUE(ARRAY_AGG(1 ORDER BY A.double) GROUP BY int64) AS m2
  PATTERN (A)
  DEFINE
    A AS int64 < 10
)
--
ALTERNATION GROUP: ANY_VALUE(ARRAY_AGG(1 ORDER BY double) GROUP BY A.int64) AS m,
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:38]
      ANY_VALUE(ARRAY_AGG(1 ORDER BY double) GROUP BY A.int64) AS m,
                                     ^
--
ALTERNATION GROUP: <empty>
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 6:38]
      ANY_VALUE(ARRAY_AGG(1 ORDER BY A.double) GROUP BY int64) AS m2
                                     ^
==

# Modifiers also detects conflict with args
SELECT * FROM SimpleTypes t
MATCH_RECOGNIZE(
  ORDER BY string
  MEASURES
      ANY_VALUE(ARRAY_AGG({{A.|t.|}}double ORDER BY {{A.|t.|}}double) GROUP BY {{A.|t.|}}int64) AS m
  PATTERN (A)
  DEFINE
    A AS int64 < 10
)
--
ALTERNATION GROUP: A.,A.,A.
--
QueryStmt
+-output_column_list=
| +-$match_recognize.m#23 AS m [ARRAY<DOUBLE>]
+-query=
  +-ProjectScan
    +-column_list=[$match_recognize.m#23]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$match_recognize.m#23]
        +-expr_list=
        | +-m#23 := ColumnRef(type=ARRAY<DOUBLE>, column=$aggregate.$agg1#22)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$aggregate.$agg1#22]
            +-input_scan=
            | +-TableScan(column_list=SimpleTypes.[int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[1, 4, 8], alias="t")
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            |   +-name="A"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            |       +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            |       +-Literal(type=INT64, value=10)
            +-pattern=
            | +-MatchRecognizePatternVariableRef(name="A")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
                +-pattern_variable_ref=
                | +-MatchRecognizePatternVariableRef(name="A")
                +-aggregate_list=
                  +-$agg1#22 :=
                    +-AggregateFunctionCall(ZetaSQL:any_value(ARRAY<DOUBLE>) -> ARRAY<DOUBLE>)
                      +-ColumnRef(type=ARRAY<DOUBLE>, column=$aggregate.$agg1#21)
                      +-group_by_list=
                      | +-$groupbymod#20 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                      +-group_by_aggregate_list=
                        +-$agg1#21 :=
                          +-AggregateFunctionCall(ZetaSQL:array_agg(DOUBLE) -> ARRAY<DOUBLE>)
                            +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
                            +-order_by_item_list=
                              +-OrderByItem
                                +-column_ref=
                                  +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_6.a_5 AS m
FROM
  (
    SELECT
      SimpleTypes.int64 AS a_1,
      SimpleTypes.string AS a_2,
      SimpleTypes.double AS a_3
    FROM
      SimpleTypes
  ) AS simpletypes_4 MATCH_RECOGNIZE(
    ORDER BY simpletypes_4.a_2
    MEASURES
      ANY_VALUE(ARRAY_AGG(A.a_3
          ORDER BY A.a_3)
        GROUP BY A.a_1) AS a_5
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN (A)
    DEFINE
      A AS(simpletypes_4.a_1) < 10
  )
  AS matchrecognizescan_6;
--
ALTERNATION GROUP: A.,A.,t.
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:27]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY A.double) GROUP BY t.int64) AS m
                          ^
--
ALTERNATION GROUP: A.,A.,
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:27]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY A.double) GROUP BY int64) AS m
                          ^
--
ALTERNATION GROUP: A.,t.,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:45]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY t.double) GROUP BY A.int64) AS m
                                            ^
--
ALTERNATION GROUP: A.,t.,t.
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:27]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY t.double) GROUP BY t.int64) AS m
                          ^
--
ALTERNATION GROUP: A.,t.,
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:27]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY t.double) GROUP BY int64) AS m
                          ^
--
ALTERNATION GROUP: A.,,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:45]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY double) GROUP BY A.int64) AS m
                                            ^
--
ALTERNATION GROUP: A.,,t.
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:27]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY double) GROUP BY t.int64) AS m
                          ^
--
ALTERNATION GROUP: A.,,
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:27]
      ANY_VALUE(ARRAY_AGG(A.double ORDER BY double) GROUP BY int64) AS m
                          ^
--
ALTERNATION GROUP: t.,A.,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:27]
      ANY_VALUE(ARRAY_AGG(t.double ORDER BY A.double) GROUP BY A.int64) AS m
                          ^
--
ALTERNATION GROUP: t.,A.,t.
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:45]
      ANY_VALUE(ARRAY_AGG(t.double ORDER BY A.double) GROUP BY t.int64) AS m
                                            ^
--
ALTERNATION GROUP: t.,A.,
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:45]
      ANY_VALUE(ARRAY_AGG(t.double ORDER BY A.double) GROUP BY int64) AS m
                                            ^
--
ALTERNATION GROUP: t.,t.,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:27]
      ANY_VALUE(ARRAY_AGG(t.double ORDER BY t.double) GROUP BY A.int64) AS m
                          ^
--
ALTERNATION GROUPS:
    t.,t.,t.
    t.,t.,
    t.,,t.
    t.,,
    t.,t.
    t.,
    t.
    <empty>
--
QueryStmt
+-output_column_list=
| +-$match_recognize.m#23 AS m [ARRAY<DOUBLE>]
+-query=
  +-ProjectScan
    +-column_list=[$match_recognize.m#23]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$match_recognize.m#23]
        +-expr_list=
        | +-m#23 := ColumnRef(type=ARRAY<DOUBLE>, column=$aggregate.$agg1#22)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$aggregate.$agg1#22]
            +-input_scan=
            | +-TableScan(column_list=SimpleTypes.[int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[1, 4, 8], alias="t")
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            |   +-name="A"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            |       +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            |       +-Literal(type=INT64, value=10)
            +-pattern=
            | +-MatchRecognizePatternVariableRef(name="A")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
                +-aggregate_list=
                  +-$agg1#22 :=
                    +-AggregateFunctionCall(ZetaSQL:any_value(ARRAY<DOUBLE>) -> ARRAY<DOUBLE>)
                      +-ColumnRef(type=ARRAY<DOUBLE>, column=$aggregate.$agg1#21)
                      +-group_by_list=
                      | +-$groupbymod#20 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                      +-group_by_aggregate_list=
                        +-$agg1#21 :=
                          +-AggregateFunctionCall(ZetaSQL:array_agg(DOUBLE) -> ARRAY<DOUBLE>)
                            +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
                            +-order_by_item_list=
                              +-OrderByItem
                                +-column_ref=
                                  +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_6.a_5 AS m
FROM
  (
    SELECT
      SimpleTypes.int64 AS a_1,
      SimpleTypes.string AS a_2,
      SimpleTypes.double AS a_3
    FROM
      SimpleTypes
  ) AS simpletypes_4 MATCH_RECOGNIZE(
    ORDER BY simpletypes_4.a_2
    MEASURES
      ANY_VALUE(ARRAY_AGG(simpletypes_4.a_3
          ORDER BY simpletypes_4.a_3)
        GROUP BY simpletypes_4.a_1) AS a_5
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN (A)
    DEFINE
      A AS(simpletypes_4.a_1) < 10
  )
  AS matchrecognizescan_6;
--
ALTERNATION GROUP: t.,,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:27]
      ANY_VALUE(ARRAY_AGG(t.double ORDER BY double) GROUP BY A.int64) AS m
                          ^
--
ALTERNATION GROUP: A.,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:27]
      ANY_VALUE(ARRAY_AGG(double ORDER BY A.double) GROUP BY A.int64) AS m
                          ^
--
ALTERNATION GROUP: A.,t.
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:43]
      ANY_VALUE(ARRAY_AGG(double ORDER BY A.double) GROUP BY t.int64) AS m
                                          ^
--
ALTERNATION GROUP: A.,
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:43]
      ANY_VALUE(ARRAY_AGG(double ORDER BY A.double) GROUP BY int64) AS m
                                          ^
--
ALTERNATION GROUP: t.,A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:27]
      ANY_VALUE(ARRAY_AGG(double ORDER BY t.double) GROUP BY A.int64) AS m
                          ^
--
ALTERNATION GROUP: A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:27]
      ANY_VALUE(ARRAY_AGG(double ORDER BY double) GROUP BY A.int64) AS m
                          ^
==

# Pattern variables mixed on separate nested aggregations
SELECT * FROM SimpleTypes
MATCH_RECOGNIZE(
  ORDER BY string
  MEASURES
    MAX(MIN({{A.|}}int64) + MIN(B.double) GROUP BY {{A.|}}int32) AS m1
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--
ALTERNATION GROUP: A.,A.
--
ERROR: Column access ranges over pattern variable B in an expression that already ranges over a pattern variable A [at 5:28]
    MAX(MIN(A.int64) + MIN(B.double) GROUP BY A.int32) AS m1
                           ^
--
ALTERNATION GROUP: A.,
--
ERROR: Column access ranges over pattern variable A in an expression that already ranges over a all input rows [at 5:13]
    MAX(MIN(A.int64) + MIN(B.double) GROUP BY int32) AS m1
            ^
--
ALTERNATION GROUP: A.
--
ERROR: Column access ranges over all input rows in an expression that already ranges over a pattern variable A [at 5:13]
    MAX(MIN(int64) + MIN(B.double) GROUP BY A.int32) AS m1
            ^
--
ALTERNATION GROUP: <empty>
--
ERROR: Column access ranges over pattern variable B in an expression that already ranges over a all input rows [at 5:26]
    MAX(MIN(int64) + MIN(B.double) GROUP BY int32) AS m1
                         ^
==

# Partition by with a subquery
WITH t AS (SELECT 1 AS x, 2 AS y)
SELECT * FROM SimpleTypes
MATCH_RECOGNIZE(
  PARTITION BY int32 IN (SELECT x + int32 FROM t LIMIT 1)
  ORDER BY string
  MEASURES
    MAX(int32 + SUM(int32 + int64 + MIN(double) GROUP BY int64) GROUP BY int32) AS max_agg,
    ARRAY_AGG(string GROUP BY string ORDER BY MIN(double)) AS array_agg
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--
QueryStmt
+-output_column_list=
| +-$partitionby.$partitionbycol1#25 AS `$partition_by_col1` [BOOL]
| +-$match_recognize.max_agg#32 AS max_agg [DOUBLE]
| +-$match_recognize.array_agg#36 AS array_agg [ARRAY<STRING>]
+-query=
  +-WithScan
    +-column_list=[$partitionby.$partitionbycol1#25, $match_recognize.max_agg#32, $match_recognize.array_agg#36]
    +-with_entry_list=
    | +-WithEntry
    |   +-with_query_name="t"
    |   +-with_subquery=
    |     +-ProjectScan
    |       +-column_list=t.[x#1, y#2]
    |       +-expr_list=
    |       | +-x#1 := Literal(type=INT64, value=1)
    |       | +-y#2 := Literal(type=INT64, value=2)
    |       +-input_scan=
    |         +-SingleRowScan
    +-query=
      +-ProjectScan
        +-column_list=[$partitionby.$partitionbycol1#25, $match_recognize.max_agg#32, $match_recognize.array_agg#36]
        +-input_scan=
          +-ProjectScan
            +-column_list=[$partitionby.$partitionbycol1#25, $match_recognize.max_agg#32, $match_recognize.array_agg#36]
            +-expr_list=
            | +-max_agg#32 := ColumnRef(type=DOUBLE, column=$aggregate.$agg1#31)
            | +-array_agg#36 := ColumnRef(type=ARRAY<STRING>, column=$aggregate.$agg2#35)
            +-input_scan=
              +-MatchRecognizeScan
                +-column_list=[$partitionby.$partitionbycol1#25, $aggregate.$agg1#31, $aggregate.$agg2#35]
                +-input_scan=
                | +-ProjectScan
                |   +-column_list=[SimpleTypes.int32#3, SimpleTypes.int64#4, SimpleTypes.string#7, SimpleTypes.double#11, $partitionby.$partitionbycol1#25]
                |   +-expr_list=
                |   | +-$partitionbycol1#25 :=
                |   |   +-SubqueryExpr
                |   |     +-type=BOOL
                |   |     +-subquery_type=IN
                |   |     +-parameter_list=
                |   |     | +-ColumnRef(type=INT32, column=SimpleTypes.int32#3)
                |   |     +-in_expr=
                |   |     | +-Cast(INT32 -> INT64)
                |   |     |   +-ColumnRef(type=INT32, column=SimpleTypes.int32#3)
                |   |     +-subquery=
                |   |       +-LimitOffsetScan
                |   |         +-column_list=[$expr_subquery.$col1#24]
                |   |         +-input_scan=
                |   |         | +-ProjectScan
                |   |         |   +-column_list=[$expr_subquery.$col1#24]
                |   |         |   +-expr_list=
                |   |         |   | +-$col1#24 :=
                |   |         |   |   +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                |   |         |   |     +-ColumnRef(type=INT64, column=t.x#22)
                |   |         |   |     +-Cast(INT32 -> INT64)
                |   |         |   |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#3, is_correlated=TRUE)
                |   |         |   +-input_scan=
                |   |         |     +-WithRefScan(column_list=t.[x#22, y#23], with_query_name="t")
                |   |         +-limit=
                |   |           +-Literal(type=INT64, value=1)
                |   +-input_scan=
                |     +-TableScan(column_list=SimpleTypes.[int32#3, int64#4, string#7, double#11], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
                +-partition_by=
                | +-WindowPartitioning
                |   +-partition_by_list=
                |     +-ColumnRef(type=BOOL, column=$partitionby.$partitionbycol1#25)
                +-order_by=
                | +-WindowOrdering
                |   +-order_by_item_list=
                |     +-OrderByItem
                |       +-column_ref=
                |         +-ColumnRef(type=STRING, column=SimpleTypes.string#7)
                +-pattern_variable_definition_list=
                | +-MatchRecognizeVariableDefinition
                | | +-name="A"
                | | +-predicate=
                | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
                | |     +-ColumnRef(type=INT64, column=SimpleTypes.int64#4)
                | |     +-Literal(type=INT64, value=10)
                | +-MatchRecognizeVariableDefinition
                |   +-name="B"
                |   +-predicate=
                |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
                |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#3)
                |       +-Literal(type=INT32, value=10)
                +-pattern=
                | +-MatchRecognizePatternOperation
                |   +-op_type=CONCAT
                |   +-operand_list=
                |     +-MatchRecognizePatternVariableRef(name="A")
                |     +-MatchRecognizePatternVariableRef(name="B")
                +-after_match_skip_mode=END_OF_MATCH
                +-measure_group_list=
                  +-MeasureGroup
                    +-aggregate_list=
                      +-$agg1#31 :=
                      | +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                      |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                      |     +-Cast(INT32 -> DOUBLE)
                      |     | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#26)
                      |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#30)
                      |   +-group_by_list=
                      |   | +-$groupbymod#26 := ColumnRef(type=INT32, column=SimpleTypes.int32#3)
                      |   +-group_by_aggregate_list=
                      |     +-$agg1#30 :=
                      |       +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                      |         +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                      |           +-Cast(INT64 -> DOUBLE)
                      |           | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                      |           |   +-Cast(INT32 -> INT64)
                      |           |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#27)
                      |           |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#28)
                      |           +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#29)
                      |         +-group_by_list=
                      |         | +-$groupbymod#27 := ColumnRef(type=INT32, column=SimpleTypes.int32#3)
                      |         | +-$groupbymod#28 := ColumnRef(type=INT64, column=SimpleTypes.int64#4)
                      |         +-group_by_aggregate_list=
                      |           +-$agg1#29 :=
                      |             +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                      |               +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#11)
                      +-$agg2#35 :=
                        +-AggregateFunctionCall(ZetaSQL:array_agg(STRING) -> ARRAY<STRING>)
                          +-ColumnRef(type=STRING, column=$group_by_list.$groupbymod#33)
                          +-order_by_item_list=
                          | +-OrderByItem
                          |   +-column_ref=
                          |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#34)
                          +-group_by_list=
                          | +-$groupbymod#33 := ColumnRef(type=STRING, column=SimpleTypes.string#7)
                          +-group_by_aggregate_list=
                            +-$agg1#34 :=
                              +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                                +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#11)

[UNPARSED_SQL]
WITH
  t AS (
    SELECT
      1 AS a_1,
      2 AS a_2
  )
SELECT
  matchrecognizescan_14.a_8 AS a_8,
  matchrecognizescan_14.a_12 AS max_agg,
  matchrecognizescan_14.a_13 AS array_agg
FROM
  (
    SELECT
      simpletypes_7.a_3 AS a_3,
      simpletypes_7.a_4 AS a_4,
      simpletypes_7.a_5 AS a_5,
      simpletypes_7.a_6 AS a_6,
      (CAST(simpletypes_7.a_3 AS INT64) IN (
        SELECT
          (withrefscan_9.a_1) + CAST(simpletypes_7.a_3 AS INT64) AS a_10
        FROM
          t AS withrefscan_9
        LIMIT 1)) AS a_8
    FROM
      (
        SELECT
          SimpleTypes.int32 AS a_3,
          SimpleTypes.int64 AS a_4,
          SimpleTypes.string AS a_5,
          SimpleTypes.double AS a_6
        FROM
          SimpleTypes
      ) AS simpletypes_7
  ) AS projectscan_11 MATCH_RECOGNIZE(
    PARTITION BY projectscan_11.a_8
    ORDER BY projectscan_11.a_5
    MEASURES
      MAX(CAST(projectscan_11.a_3 AS DOUBLE) + (SUM(CAST(CAST(projectscan_11.a_3 AS INT64) + (projectscan_11.a_4) AS DOUBLE) +
          (MIN(projectscan_11.a_6))
          GROUP BY projectscan_11.a_3, projectscan_11.a_4))
        GROUP BY projectscan_11.a_3) AS a_12,
      ARRAY_AGG(projectscan_11.a_5
        GROUP BY projectscan_11.a_5
        ORDER BY MIN(projectscan_11.a_6)) AS a_13
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(projectscan_11.a_4) < 10,
      B AS(projectscan_11.a_3) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_14;
==

# Accessing a field on a partitioning column when the partitioning expr is
# itself a field access.
SELECT * FROM (SimpleTypes CROSS JOIN ComplexTypes)
MATCH_RECOGNIZE(
  PARTITION BY teststruct.d
  ORDER BY string
  MEASURES {{A.|}}teststruct.d.b AS m
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--
ALTERNATION GROUP: A.
--
ERROR: Cannot access columns through pattern variables. [at 5:12]
  MEASURES A.teststruct.d.b AS m
           ^
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$partitionby.d#26 AS d [STRUCT<a INT32, b STRING>]
| +-$match_recognize.m#27 AS m [STRING]
+-query=
  +-ProjectScan
    +-column_list=[$partitionby.d#26, $match_recognize.m#27]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$partitionby.d#26, $match_recognize.m#27]
        +-expr_list=
        | +-m#27 :=
        |   +-GetStructField
        |     +-type=STRING
        |     +-expr=
        |     | +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$partitionby.d#26)
        |     +-field_idx=1
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$partitionby.d#26]
            +-input_scan=
            | +-ProjectScan
            |   +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, ComplexTypes.TestStruct#24, $partitionby.d#26]
            |   +-expr_list=
            |   | +-d#26 :=
            |   |   +-GetStructField
            |   |     +-type=STRUCT<a INT32, b STRING>
            |   |     +-expr=
            |   |     | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
            |   |     +-field_idx=1
            |   +-input_scan=
            |     +-JoinScan
            |       +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, ComplexTypes.TestStruct#24]
            |       +-left_scan=
            |       | +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5], table=SimpleTypes, column_index_list=[0, 1, 4])
            |       +-right_scan=
            |         +-TableScan(column_list=[ComplexTypes.TestStruct#24], table=ComplexTypes, column_index_list=[4])
            +-partition_by=
            | +-WindowPartitioning
            |   +-partition_by_list=
            |     +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$partitionby.d#26)
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH

[UNPARSED_SQL]
SELECT
  matchrecognizescan_10.a_7 AS d,
  matchrecognizescan_10.a_7.b AS m
FROM
  (
    SELECT
      simpletypes_4.a_1 AS a_1,
      simpletypes_4.a_2 AS a_2,
      simpletypes_4.a_3 AS a_3,
      complextypes_6.a_5 AS a_5,
      complextypes_6.a_5.d AS a_7
    FROM
      (
        SELECT
          SimpleTypes.int32 AS a_1,
          SimpleTypes.int64 AS a_2,
          SimpleTypes.string AS a_3
        FROM
          SimpleTypes
      ) AS simpletypes_4
      CROSS JOIN
      (
        SELECT
          ComplexTypes.TestStruct AS a_5
        FROM
          ComplexTypes
      ) AS complextypes_6
  ) AS projectscan_8 MATCH_RECOGNIZE(
    PARTITION BY projectscan_8.a_7
    ORDER BY projectscan_8.a_3
    MEASURES
      1 AS m_9
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(projectscan_8.a_2) < 10,
      B AS(projectscan_8.a_1) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_10;
==

# Accessing a field on a partitioning column
SELECT * FROM (SimpleTypes CROSS JOIN ComplexTypes)
MATCH_RECOGNIZE(
  PARTITION BY teststruct.d
  ORDER BY string
  MEASURES
    teststruct.d.a + MAX(teststruct.d.a + SUM(teststruct.d.a + int64 + MIN(double) GROUP BY int64) GROUP BY {{int32|teststruct.d.a}}) AS max_agg,
    ARRAY_AGG(string GROUP BY string ORDER BY MIN(double)) AS array_agg
  PATTERN (A B)
  DEFINE
    A AS int64 < 10,
    B AS int32 >= 10
)
--
ALTERNATION GROUP: int32
--
QueryStmt
+-output_column_list=
| +-$partitionby.d#26 AS d [STRUCT<a INT32, b STRING>]
| +-$match_recognize.max_agg#35 AS max_agg [DOUBLE]
| +-$match_recognize.array_agg#40 AS array_agg [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$partitionby.d#26, $match_recognize.max_agg#35, $match_recognize.array_agg#40]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$partitionby.d#26, $match_recognize.max_agg#35, $match_recognize.array_agg#40]
        +-expr_list=
        | +-max_agg#35 :=
        | | +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
        | |   +-Cast(INT32 -> DOUBLE)
        | |   | +-GetStructField
        | |   |   +-type=INT32
        | |   |   +-expr=
        | |   |   | +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$partitionby.d#26)
        | |   |   +-field_idx=0
        | |   +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#34)
        | +-array_agg#40 := ColumnRef(type=ARRAY<STRING>, column=$aggregate.$agg2#39)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$partitionby.d#26, $aggregate.$agg1#34, $aggregate.$agg2#39]
            +-input_scan=
            | +-ProjectScan
            |   +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, SimpleTypes.double#9, ComplexTypes.TestStruct#24, $partitionby.d#26]
            |   +-expr_list=
            |   | +-d#26 :=
            |   |   +-GetStructField
            |   |     +-type=STRUCT<a INT32, b STRING>
            |   |     +-expr=
            |   |     | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
            |   |     +-field_idx=1
            |   +-input_scan=
            |     +-JoinScan
            |       +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, SimpleTypes.double#9, ComplexTypes.TestStruct#24]
            |       +-left_scan=
            |       | +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
            |       +-right_scan=
            |         +-TableScan(column_list=[ComplexTypes.TestStruct#24], table=ComplexTypes, column_index_list=[4])
            +-partition_by=
            | +-WindowPartitioning
            |   +-partition_by_list=
            |     +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$partitionby.d#26)
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
                +-aggregate_list=
                  +-$agg1#34 :=
                  | +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                  |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |     +-Cast(INT32 -> DOUBLE)
                  |     | +-GetStructField
                  |     |   +-type=INT32
                  |     |   +-expr=
                  |     |   | +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$group_by_list.$groupbymod#27)
                  |     |   +-field_idx=0
                  |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#33)
                  |   +-group_by_list=
                  |   | +-$groupbymod#27 :=
                  |   | | +-GetStructField
                  |   | |   +-type=STRUCT<a INT32, b STRING>
                  |   | |   +-expr=
                  |   | |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                  |   | |   +-field_idx=1
                  |   | +-$groupbymod#28 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                  |   +-group_by_aggregate_list=
                  |     +-$agg1#33 :=
                  |       +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                  |         +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |           +-Cast(INT64 -> DOUBLE)
                  |           | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                  |           |   +-Cast(INT32 -> INT64)
                  |           |   | +-GetStructField
                  |           |   |   +-type=INT32
                  |           |   |   +-expr=
                  |           |   |   | +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$group_by_list.$groupbymod#29)
                  |           |   |   +-field_idx=0
                  |           |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#31)
                  |           +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#32)
                  |         +-group_by_list=
                  |         | +-$groupbymod#29 :=
                  |         | | +-GetStructField
                  |         | |   +-type=STRUCT<a INT32, b STRING>
                  |         | |   +-expr=
                  |         | |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                  |         | |   +-field_idx=1
                  |         | +-$groupbymod#30 := ColumnRef(type=INT32, column=SimpleTypes.int32#1)
                  |         | +-$groupbymod#31 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                  |         +-group_by_aggregate_list=
                  |           +-$agg1#32 :=
                  |             +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                  |               +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
                  +-$agg2#39 :=
                    +-AggregateFunctionCall(ZetaSQL:array_agg(STRING) -> ARRAY<STRING>)
                      +-ColumnRef(type=STRING, column=$group_by_list.$groupbymod#37)
                      +-order_by_item_list=
                      | +-OrderByItem
                      |   +-column_ref=
                      |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#38)
                      +-group_by_list=
                      | +-$groupbymod#36 :=
                      | | +-GetStructField
                      | |   +-type=STRUCT<a INT32, b STRING>
                      | |   +-expr=
                      | |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                      | |   +-field_idx=1
                      | +-$groupbymod#37 := ColumnRef(type=STRING, column=SimpleTypes.string#5)
                      +-group_by_aggregate_list=
                        +-$agg1#38 :=
                          +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                            +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_12.a_8 AS d,
  CAST(matchrecognizescan_12.a_8.a AS DOUBLE) + (matchrecognizescan_12.a_10) AS max_agg,
  matchrecognizescan_12.a_11 AS array_agg
FROM
  (
    SELECT
      simpletypes_5.a_1 AS a_1,
      simpletypes_5.a_2 AS a_2,
      simpletypes_5.a_3 AS a_3,
      simpletypes_5.a_4 AS a_4,
      complextypes_7.a_6 AS a_6,
      complextypes_7.a_6.d AS a_8
    FROM
      (
        SELECT
          SimpleTypes.int32 AS a_1,
          SimpleTypes.int64 AS a_2,
          SimpleTypes.string AS a_3,
          SimpleTypes.double AS a_4
        FROM
          SimpleTypes
      ) AS simpletypes_5
      CROSS JOIN
      (
        SELECT
          ComplexTypes.TestStruct AS a_6
        FROM
          ComplexTypes
      ) AS complextypes_7
  ) AS projectscan_9 MATCH_RECOGNIZE(
    PARTITION BY projectscan_9.a_8
    ORDER BY projectscan_9.a_3
    MEASURES
      MAX(CAST(projectscan_9.a_6.d.a AS DOUBLE) + (SUM(CAST(CAST(projectscan_9.a_6.d.a AS INT64) + (projectscan_9.a_2) AS DOUBLE) +
          (MIN(projectscan_9.a_4))
          GROUP BY projectscan_9.a_6.d, projectscan_9.a_1, projectscan_9.a_2))
        GROUP BY projectscan_9.a_6.d, projectscan_9.a_1) AS a_10,
      ARRAY_AGG(projectscan_9.a_3
        GROUP BY projectscan_9.a_6.d, projectscan_9.a_3
        ORDER BY MIN(projectscan_9.a_4)) AS a_11
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(projectscan_9.a_2) < 10,
      B AS(projectscan_9.a_1) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_12;
--
ALTERNATION GROUP: teststruct.d.a
--
QueryStmt
+-output_column_list=
| +-$partitionby.d#26 AS d [STRUCT<a INT32, b STRING>]
| +-$match_recognize.max_agg#35 AS max_agg [DOUBLE]
| +-$match_recognize.array_agg#40 AS array_agg [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$partitionby.d#26, $match_recognize.max_agg#35, $match_recognize.array_agg#40]
    +-input_scan=
      +-ProjectScan
        +-column_list=[$partitionby.d#26, $match_recognize.max_agg#35, $match_recognize.array_agg#40]
        +-expr_list=
        | +-max_agg#35 :=
        | | +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
        | |   +-Cast(INT32 -> DOUBLE)
        | |   | +-GetStructField
        | |   |   +-type=INT32
        | |   |   +-expr=
        | |   |   | +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$partitionby.d#26)
        | |   |   +-field_idx=0
        | |   +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#34)
        | +-array_agg#40 := ColumnRef(type=ARRAY<STRING>, column=$aggregate.$agg2#39)
        +-input_scan=
          +-MatchRecognizeScan
            +-column_list=[$partitionby.d#26, $aggregate.$agg1#34, $aggregate.$agg2#39]
            +-input_scan=
            | +-ProjectScan
            |   +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, SimpleTypes.double#9, ComplexTypes.TestStruct#24, $partitionby.d#26]
            |   +-expr_list=
            |   | +-d#26 :=
            |   |   +-GetStructField
            |   |     +-type=STRUCT<a INT32, b STRING>
            |   |     +-expr=
            |   |     | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
            |   |     +-field_idx=1
            |   +-input_scan=
            |     +-JoinScan
            |       +-column_list=[SimpleTypes.int32#1, SimpleTypes.int64#2, SimpleTypes.string#5, SimpleTypes.double#9, ComplexTypes.TestStruct#24]
            |       +-left_scan=
            |       | +-TableScan(column_list=SimpleTypes.[int32#1, int64#2, string#5, double#9], table=SimpleTypes, column_index_list=[0, 1, 4, 8])
            |       +-right_scan=
            |         +-TableScan(column_list=[ComplexTypes.TestStruct#24], table=ComplexTypes, column_index_list=[4])
            +-partition_by=
            | +-WindowPartitioning
            |   +-partition_by_list=
            |     +-ColumnRef(type=STRUCT<a INT32, b STRING>, column=$partitionby.d#26)
            +-order_by=
            | +-WindowOrdering
            |   +-order_by_item_list=
            |     +-OrderByItem
            |       +-column_ref=
            |         +-ColumnRef(type=STRING, column=SimpleTypes.string#5)
            +-pattern_variable_definition_list=
            | +-MatchRecognizeVariableDefinition
            | | +-name="A"
            | | +-predicate=
            | |   +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
            | |     +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
            | |     +-Literal(type=INT64, value=10)
            | +-MatchRecognizeVariableDefinition
            |   +-name="B"
            |   +-predicate=
            |     +-FunctionCall(ZetaSQL:$greater_or_equal(INT32, INT32) -> BOOL)
            |       +-ColumnRef(type=INT32, column=SimpleTypes.int32#1)
            |       +-Literal(type=INT32, value=10)
            +-pattern=
            | +-MatchRecognizePatternOperation
            |   +-op_type=CONCAT
            |   +-operand_list=
            |     +-MatchRecognizePatternVariableRef(name="A")
            |     +-MatchRecognizePatternVariableRef(name="B")
            +-after_match_skip_mode=END_OF_MATCH
            +-measure_group_list=
              +-MeasureGroup
                +-aggregate_list=
                  +-$agg1#34 :=
                  | +-AggregateFunctionCall(ZetaSQL:max(DOUBLE) -> DOUBLE)
                  |   +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |     +-Cast(INT32 -> DOUBLE)
                  |     | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#28)
                  |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#33)
                  |   +-group_by_list=
                  |   | +-$groupbymod#27 :=
                  |   | | +-GetStructField
                  |   | |   +-type=STRUCT<a INT32, b STRING>
                  |   | |   +-expr=
                  |   | |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                  |   | |   +-field_idx=1
                  |   | +-$groupbymod#28 :=
                  |   |   +-GetStructField
                  |   |     +-type=INT32
                  |   |     +-expr=
                  |   |     | +-GetStructField
                  |   |     |   +-type=STRUCT<a INT32, b STRING>
                  |   |     |   +-expr=
                  |   |     |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                  |   |     |   +-field_idx=1
                  |   |     +-field_idx=0
                  |   +-group_by_aggregate_list=
                  |     +-$agg1#33 :=
                  |       +-AggregateFunctionCall(ZetaSQL:sum(DOUBLE) -> DOUBLE)
                  |         +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
                  |           +-Cast(INT64 -> DOUBLE)
                  |           | +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
                  |           |   +-Cast(INT32 -> INT64)
                  |           |   | +-ColumnRef(type=INT32, column=$group_by_list.$groupbymod#30)
                  |           |   +-ColumnRef(type=INT64, column=$group_by_list.$groupbymod#31)
                  |           +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#32)
                  |         +-group_by_list=
                  |         | +-$groupbymod#29 :=
                  |         | | +-GetStructField
                  |         | |   +-type=STRUCT<a INT32, b STRING>
                  |         | |   +-expr=
                  |         | |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                  |         | |   +-field_idx=1
                  |         | +-$groupbymod#30 :=
                  |         | | +-GetStructField
                  |         | |   +-type=INT32
                  |         | |   +-expr=
                  |         | |   | +-GetStructField
                  |         | |   |   +-type=STRUCT<a INT32, b STRING>
                  |         | |   |   +-expr=
                  |         | |   |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                  |         | |   |   +-field_idx=1
                  |         | |   +-field_idx=0
                  |         | +-$groupbymod#31 := ColumnRef(type=INT64, column=SimpleTypes.int64#2)
                  |         +-group_by_aggregate_list=
                  |           +-$agg1#32 :=
                  |             +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                  |               +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)
                  +-$agg2#39 :=
                    +-AggregateFunctionCall(ZetaSQL:array_agg(STRING) -> ARRAY<STRING>)
                      +-ColumnRef(type=STRING, column=$group_by_list.$groupbymod#37)
                      +-order_by_item_list=
                      | +-OrderByItem
                      |   +-column_ref=
                      |     +-ColumnRef(type=DOUBLE, column=$aggregate.$agg1#38)
                      +-group_by_list=
                      | +-$groupbymod#36 :=
                      | | +-GetStructField
                      | |   +-type=STRUCT<a INT32, b STRING>
                      | |   +-expr=
                      | |   | +-ColumnRef(type=STRUCT<c INT32, d STRUCT<a INT32, b STRING>>, column=ComplexTypes.TestStruct#24)
                      | |   +-field_idx=1
                      | +-$groupbymod#37 := ColumnRef(type=STRING, column=SimpleTypes.string#5)
                      +-group_by_aggregate_list=
                        +-$agg1#38 :=
                          +-AggregateFunctionCall(ZetaSQL:min(DOUBLE) -> DOUBLE)
                            +-ColumnRef(type=DOUBLE, column=SimpleTypes.double#9)

[UNPARSED_SQL]
SELECT
  matchrecognizescan_12.a_8 AS d,
  CAST(matchrecognizescan_12.a_8.a AS DOUBLE) + (matchrecognizescan_12.a_10) AS max_agg,
  matchrecognizescan_12.a_11 AS array_agg
FROM
  (
    SELECT
      simpletypes_5.a_1 AS a_1,
      simpletypes_5.a_2 AS a_2,
      simpletypes_5.a_3 AS a_3,
      simpletypes_5.a_4 AS a_4,
      complextypes_7.a_6 AS a_6,
      complextypes_7.a_6.d AS a_8
    FROM
      (
        SELECT
          SimpleTypes.int32 AS a_1,
          SimpleTypes.int64 AS a_2,
          SimpleTypes.string AS a_3,
          SimpleTypes.double AS a_4
        FROM
          SimpleTypes
      ) AS simpletypes_5
      CROSS JOIN
      (
        SELECT
          ComplexTypes.TestStruct AS a_6
        FROM
          ComplexTypes
      ) AS complextypes_7
  ) AS projectscan_9 MATCH_RECOGNIZE(
    PARTITION BY projectscan_9.a_8
    ORDER BY projectscan_9.a_3
    MEASURES
      MAX(CAST(projectscan_9.a_6.d.a AS DOUBLE) + (SUM(CAST(CAST(projectscan_9.a_6.d.a AS INT64) + (projectscan_9.a_2) AS DOUBLE) +
          (MIN(projectscan_9.a_4))
          GROUP BY projectscan_9.a_6.d, projectscan_9.a_6.d.a, projectscan_9.a_2))
        GROUP BY projectscan_9.a_6.d, projectscan_9.a_6.d.a) AS a_10,
      ARRAY_AGG(projectscan_9.a_3
        GROUP BY projectscan_9.a_6.d, projectscan_9.a_3
        ORDER BY MIN(projectscan_9.a_4)) AS a_11
    AFTER MATCH SKIP PAST LAST ROW
    PATTERN ((A  B))
    DEFINE
      A AS(projectscan_9.a_2) < 10,
      B AS(projectscan_9.a_1) >= CAST(10 AS INT32)
  )
  AS matchrecognizescan_12;
